%=============================================================================
%
%                   SAME-PAGE ENDORSEMENT FORMAT MODULE
%
%=============================================================================
%
% References:
%   - SECNAV M-5216.5 (DON Correspondence Manual), Chapter 9
%   - Figures 9-1, 9-2
%
% What It's For:
%   Use an endorsement to forward comments, recommendations, or
%   information when correspondence is transmitted via your activity.
%
% When to Use Same-Page:
%   - Endorsement completely fits on signature page of basic letter
%     or preceding endorsement
%   - May omit SSIC, subject, and basic letter's ID symbols if
%     entire page will be photocopied
%
% Key Rules:
%   - Horizontal line separates basic letter from endorsement
%   - DO NOT repeat references already in basic letter
%   - DO NOT repeat enclosures already in basic letter
%   - Continue numbering sequences from basic letter
%
%=============================================================================


%=============================================================================
%                    ENDORSEMENT CONFIGURATION
%=============================================================================

\newcommand{\EndorsementOrdinal}{}      % FIRST, SECOND, THIRD, etc.
\newcommand{\EndorsementSerial}{}       % Ser XXX/### (for same-page, often omitted)
\newcommand{\EndorsementDate}{}         % Date of endorsement
\newcommand{\BasicLetterID}{}           % Basic letter identification (optional for same-page)

\newcommand{\setEndorsement}[3]{%
    \renewcommand{\EndorsementOrdinal}{#1}%
    \renewcommand{\EndorsementSerial}{#2}%
    \renewcommand{\EndorsementDate}{#3}%
}

% Set basic letter ID (e.g., "USS SCRANTON ltr 3000 Ser SSN 756/001 of 5 May 96")
\newcommand{\setBasicLetterID}[1]{\renewcommand{\BasicLetterID}{#1}}


%=============================================================================
%                    ENDORSEMENT LINE AND DATE
%=============================================================================
% Same-page endorsement starts with horizontal rule
% May omit SSIC, subject, and basic letter ID (entire page photocopied)

\newcommand{\printDateAndTitle}{%
    \vspace{24pt}%
    \noindent\rule{\textwidth}{0.4pt}\\[12pt]%
    \hfill
    \begin{tabular}[t]{@{}l@{}}
        \ifdefempty{\EndorsementSerial}{}{%
            \EndorsementSerial\\
        }%
        \EndorsementDate
    \end{tabular}\\[12pt]
    % Endorsement line - include basic letter ID if provided
    \noindent\MakeUppercase{\EndorsementOrdinal} ENDORSEMENT%
    \ifdefempty{\BasicLetterID}{}{ on \BasicLetterID}%
    \\[12pt]
}


%=============================================================================
%                    FROM / TO / VIA BLOCK
%=============================================================================
% Via line only shows REMAINING addressees
% If only one Via remains, do NOT number it
% If more than one remains, number starting with (1), (2), etc.

\newcommand{\printAddressBlock}{%
    \noindent
    \begin{tabular}[t]{@{}l@{\hspace{1em}}p{5.5in}@{}}
        From: & \FromLine\ifdefempty{\FromLineTwo}{}{\tabularnewline & \FromLineTwo}\ifdefempty{\FromLineThree}{}{\tabularnewline & \FromLineThree}\ifdefempty{\FromLineFour}{}{\tabularnewline & \FromLineFour}\tabularnewline
        To: & \ToLine\ifdefempty{\ToLineTwo}{}{\tabularnewline & \ToLineTwo}\ifdefempty{\ToLineThree}{}{\tabularnewline & \ToLineThree}\ifdefempty{\ToLineFour}{}{\tabularnewline & \ToLineFour}\tabularnewline
        \ifViaEnabled
            Via: & \ViaLineOne\ifdefempty{\ViaLineTwo}{}{\tabularnewline & \ViaLineTwo}\ifdefempty{\ViaLineThree}{}{\tabularnewline & \ViaLineThree}\ifdefempty{\ViaLineFour}{}{\tabularnewline & \ViaLineFour}\tabularnewline
        \fi
    \end{tabular}%
    %
    % CUI block
    \ifCUIEnabled
        \par\vspace{12pt}%
        \noindent
        Controlled by: \CUIControlledBy\\
        CUI Category: \CUICategory\\
        Limited Dissemination Control: \CUIDissemination\\
        POC: \href{mailto:\POCEmail}{\POCEmail}%
        \par\vspace{12pt}%
        \noindent\CUIDistStatement
    \fi
    %
    % Classified block
    \ifClassifiedEnabled
        \par\vspace{12pt}%
        \noindent
        Classified by: \ClassifiedBy\\
        Derived from: \DerivedFrom\\
        Reason: \ClassificationReason\\
        Declassify on: \DeclassifyOn\\
        POC: \href{mailto:\POCEmail}{\POCEmail}
    \fi
}


%=============================================================================
%                    SIGNATURE BLOCK
%=============================================================================
% Name only OR with "By direction"

\newcommand{\printSignature}{%
    \vspace{36pt}%
    \hspace{3.25in}%
    \begin{minipage}{3in}
        \raggedright
        % Optional: Signature image
        \ifNotEmpty{\SignatureImage}{%
            \IfFileExists{attachments/\SignatureImage}{%
                \includegraphics[width=1.5in,height=0.5in,keepaspectratio]{attachments/\SignatureImage}\\[6pt]%
            }{}%
        }%
        % Required: Name only (abbreviated format preferred)
        \ifNotEmptyElse{\SignatoryAbbrev}{\SignatoryAbbrev\\}{\MakeUppercase{\SignatoryName}\\}%
        % Optional: By direction authority line
        \optionalField{\ByDirection}%
    \end{minipage}
}


%=============================================================================
%                         LETTERHEAD OVERRIDE
%=============================================================================
% Same-page endorsement does NOT use new letterhead (on same page)

\renewcommand{\printLetterhead}{}


%=============================================================================
%                              PAGE STYLE
%=============================================================================
% Same-page endorsement continues from previous page numbering

\fancypagestyle{firstpage}{%
    \fancyhf{}%
    \fancyhead[C]{\placeClassificationMarkings}%
    \fancyfoot[C]{}%
    \renewcommand{\headrulewidth}{0pt}%
    \renewcommand{\footrulewidth}{0pt}%
}

\fancypagestyle{documentpage}{%
    \fancyhf{}%
    \fancyhead[C]{\placeClassificationMarkings}%
    \fancyfoot[C]{\thepage}%
    \renewcommand{\headrulewidth}{0pt}%
    \renewcommand{\footrulewidth}{0pt}%
}
